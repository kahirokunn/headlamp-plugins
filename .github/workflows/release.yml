name: Release Headlamp plugins (matrix)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.1.0)"
        required: true
        type: string

jobs:
  validate:
    name: Validate version and tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      normalized_version: ${{ steps.norm.outputs.normalized_version }}
      tag: ${{ steps.norm.outputs.tag }}
    steps:
      - name: Validate and normalize version
        id: norm
        shell: bash
        run: |
          set -euo pipefail
          INPUT="${{ inputs.version }}"
          if [ -z "${INPUT:-}" ]; then
            echo "::error::version input is required"
            exit 1
          fi
          VERSION="${INPUT#v}"
          VERSION="${VERSION#V}"
          if ! [[ "$VERSION" =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "::error::Invalid semver: $VERSION"
            exit 1
          fi
          TAG="v${VERSION}"
          if git ls-remote --exit-code --tags "https://github.com/${{ github.repository }}.git" "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "::error::Tag ${TAG} already exists on remote."
            exit 1
          fi
          echo "normalized_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

  release:
    name: Release ${{ matrix.plugin }}
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - plugin: envoy-gateway
            dir: envoy-gateway
          - plugin: knative
            dir: knative
    env:
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.dir }}

      - name: Audit dependencies
        run: npm audit --omit=dev --audit-level=high
        working-directory: ${{ matrix.dir }}

      - name: Sync package.json version with tag
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          VERSION_FROM_TAG="${TAG#v}"
          npm version --no-git-tag-version "$VERSION_FROM_TAG"

      - name: Build
        run: npm run build
        working-directory: ${{ matrix.dir }}

      - name: Package
        run: npm run package
        working-directory: ${{ matrix.dir }}

      - name: Resolve tarball path
        id: tar
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          PKG_NAME=$(node -p "require('./package.json').name")
          VERSION_FROM_TAG="${TAG#v}"
          TARBALL="${PKG_NAME}-${VERSION_FROM_TAG}.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            TARBALL=$(ls -1 *.tar.gz | head -n1)
          fi
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Compute checksum
        id: sum
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          SHASUM=$(sha256sum "${{ steps.tar.outputs.tarball }}" | awk '{print $1}')
          echo "$SHASUM  ${{ steps.tar.outputs.tarball }}" > "${{ steps.tar.outputs.tarball }}.sha256"
          echo "sha256=${SHASUM}" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.plugin }}-assets
          path: |
            ${{ matrix.dir }}/${{ steps.tar.outputs.tarball }}
            ${{ matrix.dir }}/${{ steps.tar.outputs.tarball }}.sha256

      - name: Install yq
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Update ArtifactHub package file
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          : "${GITHUB_TOKEN:?GITHUB_TOKEN is required}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          REPO="${{ github.repository }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Switch to default branch to update metadata there
          git fetch origin "${DEFAULT_BRANCH}"
          git checkout "${DEFAULT_BRANCH}"

          PKG_NAME=$(node -p "require('./${{ matrix.dir }}/package.json').name")
          CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TARBALL="${{ steps.tar.outputs.tarball }}"
          CHECKSUM="${{ steps.sum.outputs.sha256 }}"
          ARCHIVE_URL="https://github.com/${REPO}/releases/download/${{ env.TAG }}/${TARBALL}"
          VERSION_FROM_TAG="${TAG#v}"

          FILE="${{ matrix.dir }}/artifacthub-pkg.yml"
          export VERSION_FROM_TAG CREATED_AT ARCHIVE_URL CHECKSUM
          yq -i '.version = strenv(VERSION_FROM_TAG)' "$FILE"
          yq -i '.createdAt = strenv(CREATED_AT)' "$FILE"
          yq -i '.annotations["headlamp/plugin/archive-url"] = strenv(ARCHIVE_URL)' "$FILE"
          yq -i '.annotations["headlamp/plugin/archive-checksum"] = strenv(CHECKSUM)' "$FILE"
          echo "pkg_name=$PKG_NAME" >> "$GITHUB_OUTPUT"

          if git diff --quiet -- "$FILE"; then
            echo "No changes to commit."
            exit 0
          fi

          git add "$FILE"
          git commit -m "chore(${PKG_NAME}): update artifacthub-pkg.yml for ${VERSION_FROM_TAG}"

          # Retry push in case of race with other matrix jobs
          for i in 1 2 3 4 5; do
            git pull --rebase origin "${DEFAULT_BRANCH}" || true
            if git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git" "HEAD:${DEFAULT_BRANCH}"; then
              echo "Pushed successfully."
              break
            fi
            echo "Push failed. Retrying ($i/5)..."
            sleep 2
          done

  publish_release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - validate
      - release
    permissions:
      contents: write
    env:
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Create and push tag
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists locally."
          fi
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists on remote. Skipping creation."
          else
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "refs/tags/${TAG}"
          fi

      - name: Download assets
        uses: actions/download-artifact@v4
        with:
          path: dist-assets
          merge-multiple: true

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            dist-assets/**/*.tar.gz
            dist-assets/**/*.tar.gz.sha256
          generate_release_notes: true
