name: Release Headlamp plugins

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.1.0)"
        required: true
        type: string

jobs:
  validate:
    name: Validate version and tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      normalized_version: ${{ steps.norm.outputs.normalized_version }}
      tag: ${{ steps.norm.outputs.tag }}
    steps:
      - name: Validate and normalize version
        id: norm
        shell: bash
        run: |
          set -euo pipefail
          INPUT="${{ inputs.version }}"
          if [ -z "${INPUT:-}" ]; then
            echo "::error::version input is required"
            exit 1
          fi
          VERSION="${INPUT#v}"
          VERSION="${VERSION#V}"
          if ! [[ "$VERSION" =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "::error::Invalid semver: $VERSION"
            exit 1
          fi
          TAG="v${VERSION}"
          if git ls-remote --exit-code --tags "https://github.com/${{ github.repository }}.git" "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "::error::Tag ${TAG} already exists on remote."
            exit 1
          fi
          echo "normalized_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

  release:
    name: Release ${{ matrix.plugin }}
    runs-on: ubuntu-latest
    needs:
      - validate
      - discover_plugins
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover_plugins.outputs.matrix) }}
    env:
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.dir }}

      - name: Audit dependencies
        run: npm audit --omit=dev --audit-level=high
        working-directory: ${{ matrix.dir }}

      - name: Sync package.json version with tag
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          VERSION_FROM_TAG="${TAG#v}"
          npm version --no-git-tag-version "$VERSION_FROM_TAG"

      - name: Build
        run: npm run build
        working-directory: ${{ matrix.dir }}

      - name: Package
        run: npm run package
        working-directory: ${{ matrix.dir }}

      - name: Resolve tarball path
        id: tar
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          PKG_NAME=$(node -p "require('./package.json').name")
          VERSION_FROM_TAG="${TAG#v}"
          TARBALL="${PKG_NAME}-${VERSION_FROM_TAG}.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            TARBALL=$(ls -1 *.tar.gz | head -n1)
          fi
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Compute checksum
        id: sum
        shell: bash
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          SHASUM=$(sha256sum "${{ steps.tar.outputs.tarball }}" | awk '{print $1}')
          echo "$SHASUM  ${{ steps.tar.outputs.tarball }}" > "${{ steps.tar.outputs.tarball }}.sha256"
          echo "sha256=${SHASUM}" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.plugin }}-assets
          path: |
            ${{ matrix.dir }}/${{ steps.tar.outputs.tarball }}
            ${{ matrix.dir }}/${{ steps.tar.outputs.tarball }}.sha256

  update_artifacthub_metadata:
    name: Update ArtifactHub metadata
    runs-on: ubuntu-latest
    needs:
      - validate
      - release
      - discover_plugins
    permissions:
      contents: write
    env:
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install yq
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Download assets
        uses: actions/download-artifact@v4
        with:
          path: dist-assets
          merge-multiple: true

      - name: Update both artifacthub-pkg.yml and push
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PLUGIN_DIRS: ${{ needs.discover_plugins.outputs.plugin_dirs }}
        run: |
          set -euo pipefail
          : "${GITHUB_TOKEN:?GITHUB_TOKEN is required}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          REPO="${{ github.repository }}"
          VERSION_FROM_TAG="${TAG#v}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          if [ -z "${PLUGIN_DIRS:-}" ]; then
            echo "No plugin directories discovered. Skipping ArtifactHub metadata update."
            exit 0
          fi

          for DIR in ${PLUGIN_DIRS}; do
            PKG_NAME=$(node -p "require('./${DIR}/package.json').name")
            TARBALL="${PKG_NAME}-${VERSION_FROM_TAG}.tar.gz"
            SHA_FILE="dist-assets/${TARBALL}.sha256"
            if [ -f "${SHA_FILE}" ]; then
              CHECKSUM=$(awk '{print $1}' "${SHA_FILE}")
            else
              CHECKSUM=$(sha256sum "dist-assets/${TARBALL}" | awk '{print $1}')
            fi
            ARCHIVE_URL="https://github.com/${REPO}/releases/download/${TAG}/${TARBALL}"
            FILE="${DIR}/artifacthub-pkg.yml"
            export VERSION_FROM_TAG CREATED_AT ARCHIVE_URL CHECKSUM
            yq -i '.version = strenv(VERSION_FROM_TAG)' "$FILE"
            yq -i '.createdAt = strenv(CREATED_AT)' "$FILE"
            yq -i '.annotations["headlamp/plugin/archive-url"] = strenv(ARCHIVE_URL)' "$FILE"
            yq -i '.annotations["headlamp/plugin/archive-checksum"] = strenv(CHECKSUM)' "$FILE"
          done

          # Build the list of modified ArtifactHub files dynamically
          FILES=()
          for DIR in ${PLUGIN_DIRS}; do
            FILES+=("${DIR}/artifacthub-pkg.yml")
          done

          if git diff --quiet -- "${FILES[@]}"; then
            echo "No changes to commit."
            exit 0
          fi

          git add "${FILES[@]}"
          git commit -m "chore: update artifacthub-pkg.yml for ${VERSION_FROM_TAG}"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git" "HEAD:${DEFAULT_BRANCH}"

  discover_plugins:
    name: Discover plugins
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      plugin_dirs: ${{ steps.discover.outputs.plugin_dirs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Discover plugin directories (artifacthub-pkg.yml)
        id: discover
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const root = process.cwd();
            const isDir = (p) => {
              try { return fs.statSync(p).isDirectory(); } catch { return false; }
            };
            const hasArtifactHub = (d) => fs.existsSync(path.join(root, d, 'artifacthub-pkg.yml'));
            const entries = fs.readdirSync(root, { withFileTypes: true });
            const dirs = entries
              .filter(e => e.isDirectory() && !e.name.startsWith('.'))
              .map(e => e.name)
              .filter(d => hasArtifactHub(d));
            const include = dirs.map(d => ({ plugin: d, dir: d }));
            core.setOutput('matrix', JSON.stringify({ include }));
            core.setOutput('plugin_dirs', dirs.join(' '));
            core.info(`Discovered plugins: ${dirs.join(', ') || '(none)'}`);

  publish_release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - validate
      - release
      - update_artifacthub_metadata
    permissions:
      contents: write
    env:
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Create and push tag
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists locally."
          fi
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists on remote. Skipping creation."
          else
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "refs/tags/${TAG}"
          fi

      - name: Download assets
        uses: actions/download-artifact@v4
        with:
          path: dist-assets
          merge-multiple: true

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            dist-assets/**/*.tar.gz
            dist-assets/**/*.tar.gz.sha256
          generate_release_notes: true
